# Component: toolobserve
# OpenTelemetry-based observability

direction: right

vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 0
  }
  observe-fill: "#e53e3e"
  source-fill: "#3182ce"
  exporter-fill: "#38a169"
}

classes: {
  container: {
    style: {
      border-radius: 12
      shadow: true
      font-size: 14
      bold: true
    }
  }
  observe-node: {
    style: {
      fill: ${observe-fill}
      stroke: "#c53030"
      stroke-width: 2
      font-color: "#fff"
    }
  }
  source-node: {
    style: {
      fill: ${source-fill}
      stroke: "#2c5282"
      stroke-width: 2
      font-color: "#fff"
    }
  }
  exporter-node: {
    style: {
      fill: ${exporter-fill}
      stroke: "#276749"
      stroke-width: 2
      font-color: "#fff"
    }
  }
  data-flow: {
    style: {
      stroke: "#4a5568"
      stroke-width: 2
    }
  }
}

# Title
title: "toolobserve - Observability" {
  shape: text
  near: top-center
  style: {
    font-size: 28
    bold: true
    font-color: "#1a365d"
  }
}

# Instrumented Sources
sources: "ðŸ“¥ Instrumented" {
  class: container
  style: {
    fill: "#ebf8ff"
    stroke: ${source-fill}
  }

  toolrun: "toolrun\nExecution" {
    shape: step
    class: source-node
  }

  toolruntime: "toolruntime\nSandbox" {
    shape: cloud
    class: source-node
  }

  metatools: "metatools-mcp\nMCP Server" {
    shape: hexagon
    class: source-node
  }
}

# Core Component
core: "ðŸ“Š toolobserve" {
  class: container
  style: {
    fill: "#fff5f5"
    stroke: ${observe-fill}
    stroke-width: 3
  }

  middleware: "Middleware\nWrap Calls" {
    shape: hexagon
    class: observe-node
  }

  traces: "Traces\nSpan Recording" {
    shape: step
    class: observe-node
  }

  metrics: "Metrics\nCounters/Histograms" {
    shape: step
    class: observe-node
  }

  middleware -> traces: "records"
  middleware -> metrics: "collects"
}

# Exporters
exporters: "ðŸ“¤ Exporters" {
  class: container
  style: {
    fill: "#f0fff4"
    stroke: ${exporter-fill}
  }

  otlp: "OTLP\nOpenTelemetry" {
    shape: hexagon
    class: exporter-node
  }

  jaeger: "Jaeger\nDistributed Tracing" {
    shape: hexagon
    class: exporter-node
  }

  prometheus: "Prometheus\nMetrics Scrape" {
    shape: hexagon
    class: exporter-node
  }

  stdout: "Stdout\nDevelopment" {
    shape: hexagon
    class: exporter-node
  }
}

# Connections
sources.toolrun -> core.middleware: "instrument" {
  class: data-flow
}
sources.toolruntime -> core.middleware: "instrument" {
  class: data-flow
}
sources.metatools -> core.middleware: "instrument" {
  class: data-flow
}

core.traces -> exporters.otlp: "export" {
  class: data-flow
  style.stroke: ${exporter-fill}
}
core.traces -> exporters.jaeger: "export" {
  class: data-flow
  style.stroke: ${exporter-fill}
}
core.metrics -> exporters.prometheus: "expose" {
  class: data-flow
  style.stroke: ${exporter-fill}
}
core.traces -> exporters.stdout: "log" {
  class: data-flow
  style.stroke: ${exporter-fill}
  style.stroke-dash: 3
}

# Note
note: |md
  ## Telemetry Data

  - **Spans**: Tool execution traces
  - **Metrics**: Call counts, latency
  - **Attributes**: Tool ID, backend
  - **Events**: Errors, results
| {
  near: bottom-right
  style: {
    fill: "#f7fafc"
    stroke: "#e2e8f0"
    font-size: 10
    border-radius: 8
  }
}
