# toolexec Component Diagram
# Execution layer: run, code, runtime, backend packages

direction: down

vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 0
  }
  execution-fill: "#38a169"
  execution-stroke: "#276749"
}

classes: {
  package: {
    style: {
      fill: ${execution-fill}
      stroke: ${execution-stroke}
      stroke-width: 2
      font-color: "#fff"
      border-radius: 8
    }
  }
  type: {
    style: {
      fill: "#f0fff4"
      stroke: ${execution-stroke}
      stroke-width: 1
    }
  }
  interface: {
    style: {
      fill: "#c6f6d5"
      stroke: ${execution-stroke}
      stroke-width: 1
      stroke-dash: 3
    }
  }
}

toolexec: "▶️ toolexec" {
  style: {
    fill: "#f0fff4"
    stroke: ${execution-stroke}
    stroke-width: 2
    border-radius: 12
    shadow: true
  }

  run: "run" {
    class: package

    Runner: "Runner\n- index Index\n- backends BackendRegistry\n- middleware []Middleware" {
      shape: class
      class: type
    }

    RunResult: "RunResult\n- Output any\n- Error error\n- Duration time.Duration\n- Metadata map" {
      shape: class
      class: type
    }

    Pipeline: "Pipeline\n1. Validate Input\n2. Resolve Backend\n3. Execute\n4. Normalize\n5. Validate Output" {
      shape: step
      class: type
    }

    Runner -> RunResult: "returns"
    Runner -> Pipeline: "executes"
  }

  code: "code" {
    class: package

    Executor: "Executor\n- runner Runner\n- parser Parser\n- sandbox Sandbox" {
      shape: class
      class: type
    }

    CodeResult: "CodeResult\n- Output any\n- Logs []string\n- ToolCalls []ToolCall" {
      shape: class
      class: type
    }

    Executor -> CodeResult: "returns"
  }

  runtime: "runtime" {
    class: package

    Runtime: "«interface»\nRuntime\n+ Execute(ctx, tool, args) Result\n+ Cleanup() error" {
      shape: class
      class: interface
    }

    LocalRuntime: "LocalRuntime\nIn-process execution" {
      shape: class
      class: type
    }

    DockerRuntime: "DockerRuntime\nContainer isolation" {
      shape: class
      class: type
    }

    WASMRuntime: "WASMRuntime\nSandbox via wazero" {
      shape: class
      class: type
    }

    LocalRuntime -> Runtime: "implements"
    DockerRuntime -> Runtime: "implements"
    WASMRuntime -> Runtime: "implements"
  }

  backend: "backend" {
    class: package

    BackendRegistry: "BackendRegistry\n+ Register(name, Backend)\n+ Resolve(ToolBackend) Backend" {
      shape: class
      class: type
    }

    Backend: "«interface»\nBackend\n+ Execute(ctx, tool, args) (any, error)" {
      shape: class
      class: interface
    }

    LocalBackend: "LocalBackend\nIn-process handler" {
      shape: class
      class: type
    }

    ProviderBackend: "ProviderBackend\nExternal provider" {
      shape: class
      class: type
    }

    MCPBackend: "MCPBackend\nRemote MCP server" {
      shape: class
      class: type
    }

    BackendRegistry -> Backend: "manages"
    LocalBackend -> Backend: "implements"
    ProviderBackend -> Backend: "implements"
    MCPBackend -> Backend: "implements"
  }
}

# Package dependencies
toolexec.run.Runner -> toolexec.backend.BackendRegistry: "uses"
toolexec.run.Runner -> toolexec.code.Executor: "powers"
toolexec.code.Executor -> toolexec.runtime.Runtime: "isolates via"

# External dependencies
tooldiscovery: "tooldiscovery" {
  style: {
    fill: "#3182ce"
    font-color: "#fff"
  }
  index: "index.Index" {
    style: {
      fill: "#3182ce"
      font-color: "#fff"
    }
  }
}

toolfoundation: "toolfoundation" {
  style: {
    fill: "#718096"
    font-color: "#fff"
  }
  model: "model.Tool" {
    style: {
      fill: "#718096"
      font-color: "#fff"
    }
  }
}

tooldiscovery.index -> toolexec.run.Runner: "tool resolution" {
  style: {
    stroke: "#3182ce"
    stroke-width: 2
  }
}

toolfoundation.model -> toolexec.run.Runner: "schema validation" {
  style: {
    stroke: "#718096"
    stroke-width: 2
  }
}
