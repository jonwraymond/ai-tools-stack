# ApertureStack Layering Model (Consolidated)
# 6 library repos + protocol surfaces

direction: down

vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 0
  }
  foundation-fill: "#718096"
  foundation-stroke: "#4a5568"
  discovery-fill: "#3182ce"
  discovery-stroke: "#2c5282"
  execution-fill: "#38a169"
  execution-stroke: "#276749"
  composition-fill: "#805ad5"
  composition-stroke: "#6b46c1"
  operations-fill: "#e53e3e"
  operations-stroke: "#c53030"
  protocol-fill: "#d69e2e"
  protocol-stroke: "#b7791f"
  surface-fill: "#2b6cb0"
  surface-stroke: "#1a365d"
}

classes: {
  layer: {
    style: {
      border-radius: 12
      shadow: true
      font-size: 16
      bold: true
    }
  }
  foundation-component: { style: { fill: ${foundation-fill}; stroke: ${foundation-stroke}; stroke-width: 2; font-color: "#fff" } }
  discovery-component: { style: { fill: ${discovery-fill}; stroke: ${discovery-stroke}; stroke-width: 2; font-color: "#fff" } }
  execution-component: { style: { fill: ${execution-fill}; stroke: ${execution-stroke}; stroke-width: 2; font-color: "#fff" } }
  composition-component: { style: { fill: ${composition-fill}; stroke: ${composition-stroke}; stroke-width: 2; font-color: "#fff" } }
  operations-component: { style: { fill: ${operations-fill}; stroke: ${operations-stroke}; stroke-width: 2; font-color: "#fff" } }
  protocol-component: { style: { fill: ${protocol-fill}; stroke: ${protocol-stroke}; stroke-width: 2; font-color: "#fff" } }
  surface-component: { style: { fill: ${surface-fill}; stroke: ${surface-stroke}; stroke-width: 3; font-color: "#fff" } }
  data-flow: { style: { stroke: "#4a5568"; stroke-width: 2 } }
}

layer_foundation: "ðŸ§± Foundation Layer" {
  class: layer
  style: { fill: "#f7fafc"; stroke: ${foundation-stroke} }
  toolfoundation: "toolfoundation\nmodel â€¢ adapter â€¢ version" { shape: package; class: foundation-component }
}

layer_discovery: "ðŸ“‡ Discovery Layer" {
  class: layer
  style: { fill: "#ebf8ff"; stroke: ${discovery-stroke} }
  tooldiscovery: "tooldiscovery\nindex â€¢ tooldoc â€¢ search â€¢ semantic" { shape: cylinder; class: discovery-component }
}

layer_execution: "â–¶ï¸ Execution Layer" {
  class: layer
  style: { fill: "#f0fff4"; stroke: ${execution-stroke} }
  toolexec: "toolexec\nrun â€¢ code â€¢ runtime â€¢ backend" { shape: step; class: execution-component }
  toolexec_integrations: "toolexec-integrations\nruntime clients" {
    shape: package
    style: { fill: "#c6f6d5"; stroke: ${execution-stroke}; stroke-width: 2; stroke-dash: 4 }
  }
}

layer_composition: "ðŸŽ¼ Composition Layer" {
  class: layer
  style: { fill: "#faf5ff"; stroke: ${composition-stroke} }
  toolcompose: "toolcompose\nset â€¢ skill" { shape: cylinder; class: composition-component }
}

layer_operations: "ðŸ”§ Operations Layer" {
  class: layer
  style: { fill: "#fff5f5"; stroke: ${operations-stroke} }
  toolops: "toolops\nobserve â€¢ cache â€¢ auth â€¢ resilience â€¢ health" { shape: hexagon; class: operations-component }
}

layer_protocol: "ðŸ”Œ Protocol Layer" {
  class: layer
  style: { fill: "#fffff0"; stroke: ${protocol-stroke} }
  toolprotocol: "toolprotocol\ntransport â€¢ wire â€¢ content â€¢ stream â€¢ task" { shape: package; class: protocol-component }
}

layer_surface: "ðŸ”· Protocol Surfaces" {
  class: layer
  style: { fill: "#ebf8ff"; stroke: ${surface-stroke}; stroke-width: 3 }
  metatools: "metatools-mcp\nMCP Server" { shape: hexagon; class: surface-component }
  metatools_a2a: "metatools-a2a\nA2A Server" { shape: hexagon; class: surface-component }
}

layer_foundation.toolfoundation -> layer_discovery.tooldiscovery: "schemas" { class: data-flow }
layer_foundation.toolfoundation -> layer_execution.toolexec: "types" { class: data-flow }
layer_foundation.toolfoundation -> layer_composition.toolcompose: "types" { class: data-flow }
layer_foundation.toolfoundation -> layer_operations.toolops: "types" { class: data-flow }
layer_foundation.toolfoundation -> layer_protocol.toolprotocol: "types" { class: data-flow }

layer_discovery.tooldiscovery -> layer_composition.toolcompose: "toolset inputs" { class: data-flow }
layer_execution.toolexec -> layer_composition.toolcompose: "execution" { class: data-flow }
layer_execution.toolexec -> layer_execution.toolexec_integrations: "injects SDK clients" {
  class: data-flow
  style: { stroke-dash: 4 }
}

layer_protocol.toolprotocol -> layer_surface.metatools: "transport/wire" { class: data-flow }
layer_operations.toolops -> layer_surface.metatools: "observe/cache" { class: data-flow }
layer_composition.toolcompose -> layer_surface.metatools: "toolsets/skills" { class: data-flow }
layer_execution.toolexec -> layer_surface.metatools: "run/execute" { class: data-flow }
layer_discovery.tooldiscovery -> layer_surface.metatools: "search/describe" { class: data-flow }
layer_foundation.toolfoundation -> layer_surface.metatools: "schemas" { class: data-flow }

layer_protocol.toolprotocol -> layer_surface.metatools_a2a: "transport/wire" { class: data-flow }
layer_operations.toolops -> layer_surface.metatools_a2a: "observe/cache" { class: data-flow }
layer_composition.toolcompose -> layer_surface.metatools_a2a: "toolsets/skills" { class: data-flow }
layer_execution.toolexec -> layer_surface.metatools_a2a: "run/execute" { class: data-flow }
layer_discovery.tooldiscovery -> layer_surface.metatools_a2a: "search/describe" { class: data-flow }
layer_foundation.toolfoundation -> layer_surface.metatools_a2a: "schemas" { class: data-flow }
