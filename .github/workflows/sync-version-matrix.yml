name: Sync Version Matrix

on:
  push:
    branches: [main]
  workflow_dispatch: {}

permissions:
  contents: write
  pull-requests: write

jobs:
  sync:
    runs-on: ubuntu-latest
    env:
      GOPRIVATE: github.com/jonwraymond/*
      GONOSUMDB: github.com/jonwraymond/*
    steps:
      - name: Checkout ai-tools-stack
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: 1.24.x

      - name: Install ripgrep
        run: sudo apt-get update && sudo apt-get install -y ripgrep

      - name: Create GitHub App token
        id: app-token
        uses: actions/create-github-app-token@v1
        with:
          app-id: ${{ secrets.AI_TOOLS_GH_APP_ID }}
          private-key: ${{ secrets.AI_TOOLS_GH_APP_PRIVATE_KEY }}
          owner: jonwraymond

      - name: Mask secrets
        run: |
          echo "::add-mask::${{ secrets.AI_TOOLS_GH_APP_PRIVATE_KEY }}"
          echo "::add-mask::${{ secrets.AI_TOOLS_GH_APP_CLIENT_SECRET }}"
          echo "::add-mask::${{ secrets.AI_TOOLS_GH_APP_CLIENT_ID }}"
          echo "::add-mask::${{ secrets.AI_TOOLS_GH_APP_ID }}"
          echo "::add-mask::${{ steps.app-token.outputs.token }}"

      - name: Configure git
        run: |
          git config --global user.name "ai-tools-stack-bot"
          git config --global user.email "ai-tools-stack-bot@users.noreply.github.com"
          git config --global url."https://x-access-token:${{ steps.app-token.outputs.token }}@github.com/".insteadOf "https://github.com/"

      - name: Clone tool repos
        run: |
          set -euo pipefail
          mkdir -p repos
          for repo in toolfoundation tooldiscovery toolexec toolcompose toolops toolprotocol metatools-mcp metatools-a2a ai-tools-stack; do
            if [ ! -d "repos/$repo/.git" ]; then
              git clone "https://github.com/jonwraymond/$repo.git" "repos/$repo"
            fi
          done

      - name: Sync version matrices
        env:
          GH_TOKEN: ${{ steps.app-token.outputs.token }}
        run: |
          ./scripts/update-version-matrix.sh \
            --apply \
            --commit \
            --push \
            --pr \
            --auto-merge \
            --branch "chore/version-matrix" \
            --base "main" \
            --projects "$PWD/repos"
